<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>earn-dgb | Ana Sayfa</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
        }

        .header {
            background: #2d2d2d;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            color: #00ff88;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .balance {
            background: #333;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .balance i {
            color: #00ff88;
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
        }

        .tabs {
            max-width: 1200px;
            margin: 0 auto;
            background: #2d2d2d;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: #222;
            padding: 1rem 1rem 0;
            gap: 0.5rem;
        }

        .tab-button {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            color: #fff;
            background: #333;
        }

        .tab-button.active {
            background: #2d2d2d;
            color: #00ff88;
            font-weight: bold;
        }

        .tab-button i {
            margin-right: 0.5rem;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #333;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.2rem;
            color: #00ff88;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #00ff88;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #444;
            background: #2d2d2d;
            color: #fff;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: #00ff88;
            box-shadow: 0 0 5px rgba(0,255,136,0.3);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            background: #00ff88;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            background: #00cc6a;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.3);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .logout-btn {
            background: #ff4444;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #cc3333;
            transform: translateY(-1px);
        }

        .message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error { background: #ff4444; color: white; }
        .success { background: #00cc6a; color: white; }
        .warning { background: #ffaa00; color: white; }
        .info { background: #0088ff; color: white; }

        .history {
            margin-top: 1.5rem;
        }

        .history-title {
            color: #00ff88;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .history-item {
            background: #2d2d2d;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: #333;
        }

        .ptc-item {
            background: #2d2d2d;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .ptc-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .ptc-reward {
            color: #00ff88;
            font-weight: bold;
        }

        .timer {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1.5rem;
            color: #00ff88;
            font-weight: bold;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .main-container {
                padding: 1rem;
            }

            .tab-nav {
                flex-wrap: wrap;
            }

            .tab-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-coins"></i> earn-dgb
        </div>
        <div class="user-info">
            <div class="balance">
                <i class="fas fa-wallet"></i> Bakiye: <span id="userBalance">0</span> DGB
            </div>
            <button class="logout-btn" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> Çıkış
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="tabs">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="faucet">
                    <i class="fas fa-faucet"></i> Faucet
                </button>
                <button class="tab-button" data-tab="ptc">
                    <i class="fas fa-ad"></i> PTC Ads
                </button>
                <button class="tab-button" data-tab="withdraw">
                    <i class="fas fa-money-bill-wave"></i> Para Çek
                </button>
                <button class="tab-button" data-tab="settings">
                    <i class="fas fa-cog"></i> Ayarlar
                </button>
            </div>

            <!-- Faucet Tab -->
            <div id="faucet" class="tab-content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-faucet"></i> DGB Kazan
                    </div>
                    <div class="timer" id="claimTimer">
                        Sonraki claim için: <span id="timeLeft">5</span> saniye
                    </div>
                    <button class="btn" id="claimButton">
                        <i class="fas fa-hand-holding-usd"></i> Claim (0.1 DGB)
                    </button>
                    <div id="claimMessage" class="message" style="display: none;"></div>
                    <div class="history">
                        <h3 class="history-title">Son Claimler</h3>
                        <div id="claimHistory"></div>
                    </div>
                </div>
            </div>

            <!-- PTC Ads Tab -->
            <div id="ptc" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-ad"></i> PTC Reklamlar
                    </div>
                    <div id="ptcList">
                        <!-- Reklamlar admin panelinden yüklenecek -->
                    </div>
                    <div id="ptcMessage" class="message" style="display: none;"></div>
                </div>
            </div>

            <!-- Withdraw Tab -->
            <div id="withdraw" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-money-bill-wave"></i> Para Çek
                    </div>
                    <div class="form-group">
                        <label>Miktar (Minimum: 1 DGB)</label>
                        <input type="number" id="withdrawAmount" min="1" step="0.1" placeholder="Çekilecek miktar">
                    </div>
                    <button class="btn" id="withdrawButton">
                        <i class="fas fa-paper-plane"></i> Para Çek
                    </button>
                    <div id="withdrawMessage" class="message" style="display: none;"></div>
                    <div class="history">
                        <h3 class="history-title">Son İşlemler</h3>
                        <div id="withdrawHistory"></div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-cog"></i> FaucetPay Ayarları
                    </div>
                    <div class="form-group">
                        <label>FaucetPay E-posta</label>
                        <input type="email" id="faucetpayEmail" placeholder="FaucetPay e-posta adresiniz">
                    </div>
                    <button class="btn" id="saveEmailButton">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                    <div id="settingsMessage" class="message" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <script>
    (function() {
        // Güvenlik ve yapılandırma için temel konfigürasyon
        const CONFIG = {
            CLAIM_AMOUNT: 0.1,
            CLAIM_COOLDOWN: 5000, // 5 saniye
            MIN_WITHDRAW: 1,
            STORAGE_KEYS: {
                USER_EMAIL: 'userEmail',
                USER_BALANCE: 'userBalance',
                FAUCETPAY_EMAIL: 'faucetpayEmail'
            },
            MESSAGES: {
                LOGIN_REQUIRED: 'Devam etmek için giriş yapmalısınız.',
                INSUFFICIENT_BALANCE: 'Yetersiz bakiye!',
                MINIMUM_WITHDRAW: 'Minimum çekim tutarı 1 DGB!',
                FAUCETPAY_REQUIRED: 'Önce FaucetPay e-postanızı ayarlayın!',
                GENERIC_ERROR: 'Bir hata oluştu. Lütfen daha sonra tekrar deneyin.'
            }
        };

        // Yardımcı Araçlar
        const Utils = {
            showLoading(show = true) {
                const loadingElement = document.getElementById('loading');
                loadingElement.style.display = show ? 'flex' : 'none';
            },

            showMessage(elementId, text, type = 'info') {
                const messageElement = document.getElementById(elementId);
                messageElement.textContent = text;
                messageElement.className = `message ${type}`;
                messageElement.style.display = 'block';
                
                // 5 saniye sonra mesajı gizle
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            },

            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(String(email).toLowerCase());
            }
        };

        // Kullanıcı Yönetimi Sınıfı
        class UserManager {
            constructor() {
                this.userEmail = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_EMAIL);
                this.userBalance = parseFloat(localStorage.getItem(CONFIG.STORAGE_KEYS.USER_BALANCE) || '0');
                this.faucetpayEmail = localStorage.getItem(CONFIG.STORAGE_KEYS.FAUCETPAY_EMAIL) || '';
            }

            async initialize() {
                // Kullanıcı oturumu kontrolü
                if (!this.userEmail) {
                    this.redirectToLogin();
                    return false;
                }

                try {
                    await this.loadUserData();
                    this.updateBalanceUI();
                    this.setupEventListeners();
                    return true;
                } catch (error) {
                    console.error('Kullanıcı başlatma hatası:', error);
                    this.redirectToLogin();
                    return false;
                }
            }

            async loadUserData() {
                // JSONBin'den kullanıcı verilerini yükle
                try {
                    Utils.showLoading(true);
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        headers: { 
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const user = data.record.users.find(u => u.email === this.userEmail);

                    if (!user) {
                        throw new Error('Kullanıcı bulunamadı');
                    }

                    // Kullanıcı verilerini güncelle
                    this.userBalance = user.balance || 0;
                    this.faucetpayEmail = user.faucetpayEmail || '';

                    // Local storage'ı güncelle
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_BALANCE, this.userBalance.toString());
                    if (this.faucetpayEmail) {
                        localStorage.setItem(CONFIG.STORAGE_KEYS.FAUCETPAY_EMAIL, this.faucetpayEmail);
                    }

                    return user;
                } catch (error) {
                    console.error('Kullanıcı verileri yüklenirken hata:', error);
                    throw error;
                } finally {
                    Utils.showLoading(false);
                }
            }

            updateBalanceUI() {
                const balanceElement = document.getElementById('userBalance');
                if (balanceElement) {
                    balanceElement.textContent = this.userBalance.toFixed(8);
                }

                // FaucetPay email input'unu doldur
                const faucetpayEmailInput = document.getElementById('faucetpayEmail');
                if (faucetpayEmailInput) {
                    faucetpayEmailInput.value = this.faucetpayEmail || '';
                }
            }

            setupEventListeners() {
                // Çıkış butonu
                const logoutButton = document.getElementById('logoutButton');
                if (logoutButton) {
                    logoutButton.addEventListener('click', () => this.logout());
                }

                // FaucetPay email kaydetme
                const saveEmailButton = document.getElementById('saveEmailButton');
                if (saveEmailButton) {
                    saveEmailButton.addEventListener('click', () => this.saveFaucetPayEmail());
                }
            }

            async saveFaucetPayEmail() {
                const emailInput = document.getElementById('faucetpayEmail');
                const email = emailInput.value.trim();

                // Email doğrulama
                if (!email) {
                    Utils.showMessage('settingsMessage', 'Lütfen bir e-posta adresi girin.', 'error');
                    return;
                }

                if (!Utils.validateEmail(email)) {
                    Utils.showMessage('settingsMessage', 'Geçerli bir e-posta adresi girin.', 'error');
                    return;
                }

                try {
                    Utils.showLoading(true);

                    // FaucetPay hesabını doğrula
                    const isValidFaucetPay = await this.checkFaucetPay(email);
                    if (!isValidFaucetPay) {
                        Utils.showMessage('settingsMessage', 'Geçersiz FaucetPay hesabı!', 'error');
                        return;
                    }

                    // JSONBin'i güncelle
                    await this.updateUserFaucetPayEmail(email);

                    // Local storage'ı güncelle
                    localStorage.setItem(CONFIG.STORAGE_KEYS.FAUCETPAY_EMAIL, email);
                    this.faucetpayEmail = email;

                    Utils.showMessage('settingsMessage', 'FaucetPay e-posta adresi başarıyla kaydedildi!', 'success');
                } catch (error) {
                    console.error('FaucetPay email kaydetme hatası:', error);
                    Utils.showMessage('settingsMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
                } finally {
                    Utils.showLoading(false);
                }
            }

            async checkFaucetPay(email) {
                try {
                    const response = await fetch('https://faucetpay.io/api/v1/checkaddress', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_key: FAUCETPAY_API_KEY,
                            address: email,
                            currency: 'DGB'
                        })
                    });
                    const data = await response.json();
                    return data.status === 200;
                } catch (error) {
                    console.error('FaucetPay kontrol hatası:', error);
                    return false;
                }
            }

            async updateUserFaucetPayEmail(email) {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'GET',
                        headers: { 
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const userIndex = data.record.users.findIndex(u => u.email === this.userEmail);

                    if (userIndex === -1) {
                        throw new Error('Kullanıcı bulunamadı');
                    }

                    // FaucetPay email'i güncelle
                    data.record.users[userIndex].faucetpayEmail = email;

                    // Güncellenmiş veriyi geri kaydet
                    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data.record)
                    });
                } catch (error) {
                    console.error('Kullanıcı güncellemesi hatası:', error);
                    throw error;
                }
            }

            logout() {
                // Tüm local storage verilerini temizle
                localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_EMAIL);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_BALANCE);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.FAUCETPAY_EMAIL);

                // Giriş sayfasına yönlendir
                window.location.href = 'login.html';
            }

            redirectToLogin() {
                window.location.href = 'login.html';
            }
        }

        // Faucet Yönetimi Sınıfı
        class FaucetManager {
            constructor(userManager) {
                this.userManager = userManager;
                this.canClaim = true;
                this.setupClaimButton();
            }

            setupClaimButton() {
                const claimButton = document.getElementById('claimButton');
                if (claimButton) {
                    claimButton.addEventListener('click', () => this.claim());
                }
            }

            async claim() {
                // FaucetPay email kontrolü
                if (!this.userManager.faucetpayEmail) {
                    Utils.showMessage('claimMessage', CONFIG.MESSAGES.FAUCETPAY_REQUIRED, 'error');
                    return;
                }

                // Claim yapabilme durumu kontrolü
                if (!this.canClaim) return;

                try {
                    Utils.showLoading(true);
                    this.canClaim = false;

                    // FaucetPay hesabı doğrulama
                    const isValidFaucetPay = await this.userManager.checkFaucetPay(this.userManager.faucetpayEmail);
                    if (!isValidFaucetPay) {
                        Utils.showMessage('claimMessage', 'Geçersiz FaucetPay hesabı!', 'error');
                        return;
                    }

                    // Bakiye güncelleme
                    await this.updateBalance();

                    // Claim zamanlayıcısını başlat
                    this.startClaimCooldown();

                } catch (error) {
                    console.error('Claim hatası:', error);
                    Utils.showMessage('claimMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
                    this.canClaim = true;
                } finally {
                    Utils.showLoading(false);
                }
            }

            async updateBalance() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'GET',
                        headers: { 
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const userIndex = data.record.users.findIndex(u => u.email === this.userManager.userEmail);

                    if (userIndex === -1) {
                        throw new Error('Kullanıcı bulunamadı');
                    }

                    // Bakiye güncelleme
                    const claimAmount = CONFIG.CLAIM_AMOUNT;
                    data.record.users[userIndex].balance += claimAmount;

                    // Claim geçmişi
                    if (!data.record.users[userIndex].claimHistory) {
                        data.record.users[userIndex].claimHistory = [];
                    }
                    data.record.users[userIndex].claimHistory.push({
                        amount: claimAmount,
                        timestamp: new Date().toISOString()
                    });

                    // Güncellenmiş veriyi kaydet
                    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data.record)
                    });

                    // Kullanıcı yöneticisinin bakiyesini güncelle
                    this.userManager.userBalance += claimAmount;
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_BALANCE, this.userManager.userBalance.toString());

                    // UI'ı güncelle
                    this.userManager.updateBalanceUI();

                    // Başarı mesajı
                    Utils.showMessage('claimMessage', `Başarılı! ${claimAmount} DGB kazandınız!`, 'success');
                    this.updateClaimHistory(data.record.users[userIndex].claimHistory);

                } catch (error) {
                    console.error('Bakiye güncelleme hatası:', error);
                    throw error;
                }
            }

            updateClaimHistory(history) {
                const historyContainer = document.getElementById('claimHistory');
                if (!historyContainer) return;

                // En son 5 claim'i göster
                const lastClaims = history.slice(-5).reverse();
                historyContainer.innerHTML = lastClaims.map(claim => `
                    <div class="history-item">
                        <span><i class="fas fa-coins"></i> ${claim.amount} DGB</span>
                        <span>${new Date(claim.timestamp).toLocaleString()}</span>
                    </div>
                `).join('');
            }

            startClaimCooldown() {
                const claimButton = document.getElementById('claimButton');
                const timerElement = document.getElementById('timeLeft');
                
                let timeLeft = CONFIG.CLAIM_COOLDOWN / 1000;
                claimButton.disabled = true;

                const cooldownInterval = setInterval(() => {
                    timeLeft--;
                    timerElement.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(cooldownInterval);
                        claimButton.disabled = false;
                        timerElement.textContent = 'Hazır!';
                        this.canClaim = true;
                    }
                }, 1000);
            }
        }

        // Çekim Yönetimi Sınıfı
        class WithdrawManager {
            constructor(userManager) {
                this.userManager = userManager;
                this.setupWithdrawButton();
            }

            setupWithdrawButton() {
                const withdrawButton = document.getElementById('withdrawButton');
                if (withdrawButton) {
                    withdrawButton.addEventListener('click', () => this.withdraw());
                }
            }

            async withdraw() {
                const withdrawInput = document.getElementById('withdrawAmount');
                const amount = parseFloat(withdrawInput.value);

                // Miktar doğrulamaları
                if (!amount || amount < CONFIG.MIN_WITHDRAW) {
                    Utils.showMessage('withdrawMessage', CONFIG.MESSAGES.MINIMUM_WITHDRAW, 'error');
                    return;
                }

                if (amount > this.userManager.userBalance) {
    Utils.showMessage('withdrawMessage', CONFIG.MESSAGES.INSUFFICIENT_BALANCE, 'error');
    return;
}

// FaucetPay email kontrolü
if (!this.userManager.faucetpayEmail) {
    Utils.showMessage('withdrawMessage', CONFIG.MESSAGES.FAUCETPAY_REQUIRED, 'error');
    return;
}

try {
    Utils.showLoading(true);

    // FaucetPay hesabı doğrulama
    const isValidFaucetPay = await this.userManager.checkFaucetPay(this.userManager.faucetpayEmail);
    if (!isValidFaucetPay) {
        Utils.showMessage('withdrawMessage', 'Geçersiz FaucetPay hesabı!', 'error');
        return;
    }

    // Para çekme işlemi
    await this.processWithdrawal(amount);

    // Input'u temizle
    withdrawInput.value = '';

    Utils.showMessage('withdrawMessage', 'Para çekme işlemi başarılı!', 'success');
} catch (error) {
    console.error('Para çekme hatası:', error);
    Utils.showMessage('withdrawMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
} finally {
    Utils.showLoading(false);
}
                async processWithdrawal(amount) {
                try {
                    // FaucetPay'e para gönderme
                    const faucetPayResponse = await fetch('https://faucetpay.io/api/v1/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_key: FAUCETPAY_API_KEY,
                            amount: amount,
                            to: this.userManager.faucetpayEmail,
                            currency: 'DGB'
                        })
                    });

                    const faucetPayData = await faucetPayResponse.json();
                    if (faucetPayData.status !== 200) {
                        throw new Error(faucetPayData.message || 'FaucetPay transfer hatası');
                    }

                    // JSONBin'i güncelle
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'GET',
                        headers: { 
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const userIndex = data.record.users.findIndex(u => u.email === this.userManager.userEmail);

                    if (userIndex === -1) {
                        throw new Error('Kullanıcı bulunamadı');
                    }

                    // Bakiyeyi düşür
                    data.record.users[userIndex].balance -= amount;

                    // Çekim geçmişi
                    if (!data.record.users[userIndex].withdrawals) {
                        data.record.users[userIndex].withdrawals = [];
                    }
                    data.record.users[userIndex].withdrawals.push({
                        amount: amount,
                        timestamp: new Date().toISOString(),
                        status: 'success',
                        txid: faucetPayData.transfer_id
                    });

                    // Güncellenmiş veriyi kaydet
                    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data.record)
                    });

                    // Kullanıcı yöneticisinin bakiyesini güncelle
                    this.userManager.userBalance -= amount;
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_BALANCE, this.userManager.userBalance.toString());

                    // UI'ı güncelle
                    this.userManager.updateBalanceUI();

                    // Çekim geçmişini güncelle
                    this.updateWithdrawHistory(data.record.users[userIndex].withdrawals);

                } catch (error) {
                    console.error('Çekim işlemi hatası:', error);
                    throw error;
                }
            }

            updateWithdrawHistory(history) {
                const historyContainer = document.getElementById('withdrawHistory');
                if (!historyContainer) return;

                // En son 5 çekimi göster
                const lastWithdrawals = history.slice(-5).reverse();
                historyContainer.innerHTML = lastWithdrawals.map(withdrawal => `
                    <div class="history-item">
                        <span><i class="fas fa-paper-plane"></i> ${withdrawal.amount} DGB</span>
                        <span>${new Date(withdrawal.timestamp).toLocaleString()}</span>
                    </div>
                `).join('');
            }
        }

        // PTC (Paid to Click) Reklam Yönetimi Sınıfı
        class PTCManager {
            constructor(userManager) {
                this.userManager = userManager;
                this.loadPTCAds();
            }

            async loadPTCAds() {
                try {
                    Utils.showLoading(true);

                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY
                        }
                    });

                    const data = await response.json();
                    const ads = data.record.ads || [];
                    
                    const ptcList = document.getElementById('ptcList');
                    ptcList.innerHTML = '';

                    if (ads.length === 0) {
                        ptcList.innerHTML = '<p style="text-align: center; padding: 1rem;">Şu anda aktif reklam bulunmuyor.</p>';
                        return;
                    }

                    ads.forEach(ad => {
                        if (ad.active) {
                            ptcList.innerHTML += `
                                <div class="ptc-item">
                                    <div>
                                        <h3>${ad.title}</h3>
                                        <p>${ad.duration} saniye izle, kazan!</p>
                                    </div>
                                    <div>
                                        <span class="ptc-reward">${ad.reward} DGB</span>
                                        <button class="btn" onclick="app.ptcManager.viewPtcAd('${ad.id}', ${ad.duration}, ${ad.reward})">İzle</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                } catch (error) {
                    console.error('PTC reklamları yüklenirken hata:', error);
                    document.getElementById('ptcList').innerHTML = '<p style="text-align: center; color: #ff4444; padding: 1rem;">Reklamlar yüklenirken bir hata oluştu!</p>';
                } finally {
                    Utils.showLoading(false);
                }
            }

            async viewPtcAd(adId, duration, reward) {
                // FaucetPay email kontrolü
                if (!this.userManager.faucetpayEmail) {
                    Utils.showMessage('ptcMessage', CONFIG.MESSAGES.FAUCETPAY_REQUIRED, 'error');
                    return;
                }

                const buttons = document.querySelectorAll('.ptc-item .btn');
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.textContent = `${duration} saniye`;
                });

                let timeLeft = duration;
                const timer = setInterval(async () => {
                    timeLeft--;
                    buttons.forEach(btn => btn.textContent = `${timeLeft} saniye`);

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        buttons.forEach(btn => {
                            btn.disabled = false;
                            btn.textContent = 'İzle';
                        });

                        try {
                            Utils.showLoading(true);

                            // Reklam doğrulama ve bakiye güncelleme
                            await this.processAdReward(adId, reward);

                            Utils.showMessage('ptcMessage', `Tebrikler! ${reward} DGB kazandınız!`, 'success');
                        } catch (error) {
                            console.error('PTC reklam görüntüleme hatası:', error);
                            Utils.showMessage('ptcMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
                        } finally {
                            Utils.showLoading(false);
                        }
                    }
                }, 1000);
            }

            async processAdReward(adId, reward) {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'GET',
                        headers: { 
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    const userIndex = data.record.users.findIndex(u => u.email === this.userManager.userEmail);
                    const ad = data.record.ads.find(a => a.id === adId);

                    if (!ad || !ad.active) {
                        throw new Error('Reklam aktif değil');
                    }

                    // Bakiye güncelleme
                    data.record.users[userIndex].balance += reward;

                    // PTC geçmişi
                    if (!data.record.users[userIndex].ptcHistory) {
                        data.record.users[userIndex].ptcHistory = [];
                    }
                    data.record.users[userIndex].ptcHistory.push({
                        adId: adId,
                        reward: reward,
                        timestamp: new Date().toISOString()
                    });

                    // Güncellenmiş veriyi kaydet
                    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': JSONBIN_API_KEY,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data.record)
                    });

                    // Kullanıcı yöneticisinin bakiyesini güncelle
                    this.userManager.userBalance += reward;
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_BALANCE, this.userManager.userBalance.toString());

                    // UI'ı güncelle
                    this.userManager.updateBalanceUI();

                } catch (error) {
                    console.error('PTC reklam ödülü hatası:', error);
                    throw error;
                }
            }
        }

        // Tab Yönetimi
        class TabManager {
            constructor() {
                this.setupTabListeners();
            }

            setupTabListeners() {
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        this.openTab(tabName);
                    });
                });
            }

            openTab(tabName) {
                // Tüm tab içeriklerini gizle
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Tüm tab butonlarından active sınıfını kaldır
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Seçilen tab'ı ve butonunu aktifleştir
                const selectedTab = document.getElementById(tabName);
                const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
                
                if (selectedTab && selectedButton) {
                    selectedTab.classList.add('active');
                    selectedButton.classList.add('active');
                }
            }
        }

        // Ana Uygulama Başlatıcısı
        class App {
            constructor() {
                this.userManager = null;
                this.faucetManager = null;
                this.withdrawManager = null;
                this.ptcManager = null;
                this.tabManager = null;
            }

            async initialize() {
                try {
                    // Kullanıcı yöneticisini başlat
                    this.userManager = new UserManager();
                    const isLoggedIn = await this.userManager.initialize();

                    if (!isLoggedIn) return;

                    // Diğer yöneticileri başlat
                    this.faucetManager = new FaucetManager(this.userManager);
                    this.withdrawManager = new WithdrawManager(this.userManager);
                    this.ptcManager = new PTCManager(this.userManager);
                    this.tabManager = new TabManager();

                    // Sayfa yüklendiğinde ilk tab'ı aç
                    this.tabManager.openTab('faucet');
                } catch (error) {
                    console.error('Uygulama başlatma hatası:', error);
                    alert(CONFIG.MESSAGES.GENERIC_ERROR);
                }
            }
        }

        // Uygulamayı başlat
        const app = new App();
        window.app = app;
        
        // DOM yüklendiğinde uygulamayı çalıştır
        document.addEventListener('DOMContentLoaded', () => {
            app.initialize();
        });
    })();
    </script>
</body>
</html>
