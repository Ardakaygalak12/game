<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>earn-dgb | Digibyte Kazan</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary-color: #00ff88;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --hover-bg: #333;
            --text-color: #fff;
            --error-color: #ff4444;
            --success-color: #00cc6a;
            --warning-color: #ffaa00;
        }

        body {
            background: var(--dark-bg);
            color: var(--text-color);
            min-height: 100vh;
        }

        .header {
            background: var(--card-bg);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .balance {
            background: var(--hover-bg);
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .balance i {
            color: var(--primary-color);
        }

        .main-container {
            margin-top: 80px;
            padding: 2rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .tabs {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: #222;
            padding: 1rem 1rem 0;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: var(--text-color);
            background: var(--hover-bg);
        }

        .tab-button.active {
            background: var(--card-bg);
            color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .card {
            background: var(--hover-bg);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #444;
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(0,255,136,0.3);
        }

        .btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary-color);
            color: var(--dark-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--success-color);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.3);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .logout-btn {
            background: var(--error-color);
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logout-btn:hover {
            background: #cc3333;
            transform: translateY(-1px);
        }

        .message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            animation: fadeIn 0.3s ease;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .error { background: var(--error-color); color: white; }
        .success { background: var(--success-color); color: white; }
        .warning { background: var(--warning-color); color: white; }
        .info { background: #0088ff; color: white; }

        .history {
            margin-top: 1.5rem;
        }

        .history-title {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-item {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            background: var(--hover-bg);
        }

        .timer {
            text-align: center;
            margin: 1.5rem 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #333;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ref-box {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .ref-link {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .ref-link input {
            flex: 1;
            padding: 0.8rem;
            background: var(--hover-bg);
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .copy-btn {
            padding: 0.8rem 1.5rem;
            background: var(--primary-color);
            color: var(--dark-bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .ref-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: var(--hover-bg);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .main-container {
                padding: 1rem;
            }

            .tab-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-coins"></i> earn-dgb
        </div>
        <div class="user-info">
            <div class="balance">
                <i class="fas fa-wallet"></i> Bakiye: <span id="userBalance">0</span> DGB
            </div>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Çıkış
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="tabs">
            <div class="tab-nav">
                <button class="tab-button active" onclick="openTab('faucet')">
                    <i class="fas fa-faucet"></i> Faucet
                </button>
                <button class="tab-button" onclick="openTab('ptc')">
                    <i class="fas fa-ad"></i> PTC Reklamlar
                </button>
                <button class="tab-button" onclick="openTab('withdraw')">
                    <i class="fas fa-money-bill-wave"></i> Para Çek
                </button>
                <button class="tab-button" onclick="openTab('referral')">
                    <i class="fas fa-users"></i> Referans
                </button>
                <button class="tab-button" onclick="openTab('settings')">
                    <i class="fas fa-cog"></i> Ayarlar
                </button>
            </div>

            <!-- Faucet Tab -->
            <div id="faucet" class="tab-content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-faucet"></i> DGB Kazan
                    </div>
                    <div class="timer" id="claimTimer">
                        <i class="fas fa-clock"></i> Sonraki claim için: <span id="timeLeft">5</span> saniye
                    </div>
                    <button class="btn" id="claimButton" onclick="claim()">
                        <i class="fas fa-hand-holding-usd"></i> Claim (0.0078673589 DGB)
                    </button>
                    <div id="claimMessage" class="message"></div>
                    <div class="history">
                        <h3 class="history-title">
                            <i class="fas fa-history"></i> Son Claimler
                        </h3>
                        <div id="claimHistory"></div>
                    </div>
                </div>
            </div>

            <!-- PTC Ads Tab -->
            <div id="ptc" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-ad"></i> PTC Reklamlar
                    </div>
                    <div id="ptcList">
                        <!-- Reklamlar admin panelinden yüklenecek -->
                    </div>
                    <div id="ptcMessage" class="message"></div>
                </div>
            </div>

            <!-- Withdraw Tab -->
            <div id="withdraw" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-money-bill-wave"></i> Para Çek
                    </div>
                    <div class="form-group">
                        <label>Miktar (Minimum: 1 DGB)</label>
                        <input type="number" id="withdrawAmount" min="1" step="0.0000001" placeholder="Çekilecek miktar">
                    </div>
                    <button class="btn" onclick="withdraw()">
                        <i class="fas fa-paper-plane"></i> Para Çek
                    </button>
                    <div id="withdrawMessage" class="message"></div>
                    <div class="history">
                        <h3 class="history-title">
                            <i class="fas fa-history"></i> Son İşlemler
                        </h3>
                        <div id="withdrawHistory"></div>
                    </div>
                </div>
            </div>

            <!-- Referral Tab -->
            <div id="referral" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-users"></i> Referans Sistemi
                    </div>
                    <p>Arkadaşlarınızı davet edin, onların her kazancından %40 bonus kazanın!</p>
                    <div class="ref-box">
                        <div class="ref-link">
                            <input type="text" id="refLink" readonly>
                            <button class="copy-btn" onclick="copyRefLink()">
                                <i class="fas fa-copy"></i> Kopyala
                            </button>
                        </div>
                        <div class="ref-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="refCount">0</div>
                                <div>Toplam Referans</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="refEarnings">0 DGB</div>
                                <div>Referans Kazancı</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-cog"></i> FaucetPay Ayarları
                    </div>
                    <div class="form-group">
                        <label>FaucetPay E-posta</label>
                        <input type="email" id="faucetpayEmail" placeholder="FaucetPay e-posta adresiniz">
                    </div>
                    <button class="btn" onclick="saveFaucetPayEmail()">
                        <i class="fas fa-save"></i> Kaydet
                    </button>
                    <div id="settingsMessage" class="message"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>
    <script>
    // Configuration with actual API keys
const CONFIG = {
    JSONBIN_API_KEY: '$2a$10$m3ykh1NKxmtQDVM140H6TOTqsemkiBEdfdQnG/ApyhjJ1Duj2Ri6W',
    JSONBIN_BIN_ID: '67a7a415e41b4d34e4867ffe',
    FAUCETPAY_API_KEY: 'a5a15c7cc4b4d4c6a0cab0cb5d2b2ce3388070028e2c5cf37284f627975cb9ed',
    CLAIM_AMOUNT: 0.0078673589,
    MIN_WITHDRAW: 1.0,
    REF_COMMISSION: 0.40, // %40 referans komisyonu
    MESSAGES: {
        FAUCET_NO_BALANCE: 'Muslukta yeterli DGB yok! Admin onayı bekleniyor.',
        INSUFFICIENT_BALANCE: 'Yetersiz bakiye!',
        FAUCETPAY_REQUIRED: 'Lütfen FaucetPay hesabınızı ayarlayın!',
        GENERIC_ERROR: 'Bir hata oluştu. Lütfen daha sonra tekrar deneyin.'
    }
};

// Global Değişkenler
let userEmail = localStorage.getItem('userEmail');
let userBalance = parseFloat(localStorage.getItem('balance') || '0');
let faucetpayEmail = localStorage.getItem('faucetpayEmail') || '';
let canClaim = true;
let timeLeft = 5;

// Sayfa yüklendiğinde
window.onload = async function() {
    if (!userEmail) {
        window.location.href = 'login.html';
        return;
    }
    await initializeApp();
};

// Uygulama başlatma
async function initializeApp() {
    try {
        showLoading(true);
        await loadUserData();
        startClaimTimer();
        initializeReferral();
        await loadHistory();
        await loadPtcAds();
    } catch (error) {
        console.error('Başlangıç hatası:', error);
        showMessage('claimMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
    } finally {
        showLoading(false);
    }
}

// Bekleyen claim oluşturma
async function createPendingClaim() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            method: 'GET',
            headers: { 
                'X-Master-Key': CONFIG.JSONBIN_API_KEY 
            }
        });
        const data = await response.json();

        // Kullanıcı için bekleyen claim oluştur
        const userIndex = data.record.users.findIndex(u => u.email === userEmail);
        if (userIndex !== -1) {
            if (!data.record.users[userIndex].pendingClaims) {
                data.record.users[userIndex].pendingClaims = [];
            }
            
            data.record.users[userIndex].pendingClaims.push({
                amount: CONFIG.CLAIM_AMOUNT,
                timestamp: new Date().toISOString(),
                status: 'pending'
            });

            // Güncellenen veriyi geri gönder
            await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Master-Key': CONFIG.JSONBIN_API_KEY
                },
                body: JSON.stringify(data.record)
            });
        }

        showMessage('claimMessage', 'Claim beklemede. Admin onayı gerekiyor.', 'warning');
    } catch (error) {
        console.error('Bekleyen claim oluşturma hatası:', error);
        showMessage('claimMessage', 'Bekleyen claim oluşturulamadı.', 'error');
    }
}

// PTC Reklamları yükleme
async function loadPtcAds() {
    const ptcList = document.getElementById('ptcList');
    if (ptcList) {
        try {
            // PTC reklamlarını JSONBin'den çek
            const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
                headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
            });
            const data = await response.json();

            // Reklam listesini al ve ekrana bas
            const ads = data.record.ptcAds || [];
            if (ads.length > 0) {
                ptcList.innerHTML = ads.map(ad => `
                    <div class="ptc-ad">
                        <h3>${ad.title}</h3>
                        <p>${ad.description}</p>
                        <button onclick="viewPtcAd('${ad.id}')">Reklamı Görüntüle</button>
                    </div>
                `).join('');
            } else {
                ptcList.innerHTML = '<p>Şu anda reklam bulunmuyor.</p>';
            }
        } catch (error) {
            console.error('PTC reklamları yüklenirken hata:', error);
            ptcList.innerHTML = '<p>Reklamlar yüklenemedi.</p>';
        }
    }
}

// PTC Reklam görüntüleme
async function viewPtcAd(adId) {
    try {
        // Reklam görüntüleme logic
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });
        const data = await response.json();

        // Kullanıcı için reklam kazancı ekle
        const userIndex = data.record.users.findIndex(u => u.email === userEmail);
        if (userIndex !== -1) {
            const ad = data.record.ptcAds.find(a => a.id === adId);
            if (ad) {
                data.record.users[userIndex].balance += ad.reward;

                // Güncellenen veriyi geri gönder
                await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CONFIG.JSONBIN_API_KEY
                    },
                    body: JSON.stringify(data.record)
                });

                // Kullanıcı bakiyesini güncelle
                userBalance = data.record.users[userIndex].balance;
                localStorage.setItem('balance', userBalance);
                updateUI();

                showMessage('ptcMessage', `Reklam kazancı: ${ad.reward} DGB`, 'success');
            }
        }
    } catch (error) {
        console.error('Reklam görüntüleme hatası:', error);
        showMessage('ptcMessage', 'Reklam işlemi başarısız.', 'error');
    }
}

// Claim fonksiyonu
async function claim() {
    if (!canClaim) return;

    try {
        showLoading(true);

        if (!faucetpayEmail) {
            showMessage('claimMessage', CONFIG.MESSAGES.FAUCETPAY_REQUIRED, 'error');
            return;
        }

        // FaucetPay hesap kontrolü
        const faucetCheck = await checkFaucetPay(faucetpayEmail);
        if (!faucetCheck.success) {
            showMessage('claimMessage', 'Geçersiz FaucetPay hesabı!', 'error');
            return;
        }

        // Musluktaki bakiye kontrolü
        const faucetBalance = await checkFaucetBalance();
        if (!faucetBalance.success || faucetBalance.balance < CONFIG.CLAIM_AMOUNT) {
            showMessage('claimMessage', CONFIG.MESSAGES.FAUCET_NO_BALANCE, 'warning');
            await createPendingClaim();
            return;
        }

        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const userIndex = data.record.users.findIndex(u => u.email === userEmail);
        
        // Claim miktarını hesapla
        const claimAmount = CONFIG.CLAIM_AMOUNT;
        
        // Kullanıcı bakiyesini güncelle
        data.record.users[userIndex].balance += claimAmount;
        data.record.users[userIndex].lastClaim = new Date().toISOString();

        // Claim geçmişi
        if (!data.record.users[userIndex].claimHistory) {
            data.record.users[userIndex].claimHistory = [];
        }
        
        data.record.users[userIndex].claimHistory.push({
            amount: claimAmount,
            timestamp: new Date().toISOString()
        });

        // Referans ödemesi
        if (data.record.users[userIndex].referrer) {
            const referrerIndex = data.record.users.findIndex(u => u.email === data.record.users[userIndex].referrer);
            if (referrerIndex !== -1) {
                const refAmount = claimAmount * CONFIG.REF_COMMISSION;
                data.record.users[referrerIndex].balance += refAmount;
                data.record.users[referrerIndex].referralEarnings = 
                    (data.record.users[referrerIndex].referralEarnings || 0) + refAmount;
            }
        }

        await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': CONFIG.JSONBIN_API_KEY
            },
            body: JSON.stringify(data.record)
        });

        userBalance += claimAmount;
        localStorage.setItem('balance', userBalance);
        updateUI();

        showMessage('claimMessage', `Başarılı! ${claimAmount} DGB kazandınız!`, 'success');
        await loadHistory();

        canClaim = false;
        startClaimTimer();

    } catch (error) {
        console.error('Claim hatası:', error);
        showMessage('claimMessage', CONFIG.MESSAGES.GENERIC_ERROR, 'error');
    } finally {
        showLoading(false);
    }
}

// FaucetPay hesap kontrolü
async function checkFaucetPay(email) {
    try {
        const response = await fetch('https://faucetpay.io/api/v1/checkaddress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: CONFIG.FAUCETPAY_API_KEY,
                address: email,
                currency: 'DGB'
            })
        });
        
        const data = await response.json();
        return {
            success: data.status === 200,
            message: data.message
        };
    } catch (error) {
        console.error('FaucetPay kontrol hatası:', error);
        return { success: false, message: error.message };
    }
}

// Faucet bakiye kontrolü
async function checkFaucetBalance() {
    try {
        const response = await fetch('https://faucetpay.io/api/v1/getbalance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: CONFIG.FAUCETPAY_API_KEY,
                currency: 'DGB'
            })
        });
        
        const data = await response.json();
        return {
            success: data.status === 200,
            balance: parseFloat(data.balance)
        };
    } catch (error) {
        console.error('Faucet bakiye kontrolü hatası:', error);
        return { success: false, balance: 0 };
    }
}

// Para çekme fonksiyonu
async function withdraw() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    
    if (!amount || amount < CONFIG.MIN_WITHDRAW) {
        showMessage('withdrawMessage', 'Minimum çekim tutarı 1 DGB!', 'error');
        return;
    }

    if (amount > userBalance) {
        showMessage('withdrawMessage', CONFIG.MESSAGES.INSUFFICIENT_BALANCE, 'error');
        return;
    }

    if (!faucetpayEmail) {
        showMessage('withdrawMessage', CONFIG.MESSAGES.FAUCETPAY_REQUIRED, 'error');
        return;
    }

    try {
        showLoading(true);

        // FaucetPay bakiye kontrolü
        const faucetBalance = await checkFaucetBalance();
        if (!faucetBalance.success || faucetBalance.balance < amount) {
            showMessage('withdrawMessage', 'Muslukta yeterli bakiye yok! Lütfen daha sonra tekrar deneyin.', 'warning');
            return;
        }

        // FaucetPay transfer
        const transferResult = await sendToFaucetPay(faucetpayEmail, amount);
        if (!transferResult.success) {
            showMessage('withdrawMessage', `FaucetPay hatası: ${transferResult.message}`, 'error');
            return;
        }

        // Bakiye güncelleme
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const userIndex = data.record.users.findIndex(u => u.email === userEmail);

        data.record.users[userIndex].balance -= amount;
        
        if (!data.record.users[userIndex].withdrawals) {
            data.record.users[userIndex].withdrawals = [];
        }

        data.record.users[userIndex].withdrawals.push({
            amount: amount,
            timestamp: new Date().toISOString(),
            txid: transferResult.txid
        });

        await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': CONFIG.JSONBIN_API_KEY
            },
            body: JSON.stringify(data.record)
        });

        userBalance -= amount;
        localStorage.setItem('balance', userBalance);
        updateUI();

                document.getElementById('withdrawAmount').value = '';
        showMessage('withdrawMessage', 'Para çekme işlemi başarılı!', 'success');
        await loadHistory();

    } catch (error) {
        console.error('Para çekme hatası:', error);
        showMessage('withdrawMessage', 'Para çekme işlemi başarısız!', 'error');
    } finally {
        showLoading(false);
    }
}
        // FaucetPay'e gönderme
async function sendToFaucetPay(email, amount) {
    try {
        const response = await fetch('https://faucetpay.io/api/v1/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api_key: CONFIG.FAUCETPAY_API_KEY,
                amount: amount,
                to: email,
                currency: 'DGB'
            })
        });

        const data = await response.json();
        return {
            success: data.status === 200,
            message: data.message,
            txid: data.transfer_id
        };
    } catch (error) {
        return {
            success: false,
            message: error.message,
            txid: null
        };
    }
}

// Referans sistemini başlatma
function initializeReferral() {
    const refLink = `${window.location.origin}${window.location.pathname}?ref=${btoa(userEmail)}`;
    const refLinkInput = document.getElementById('refLink');
    if (refLinkInput) {
        refLinkInput.value = refLink;
    }
    updateReferralStats();
}

// Referans istatistiklerini güncelleme
async function updateReferralStats() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const user = data.record.users.find(u => u.email === userEmail);

        if (user) {
            const refCount = user.referrals ? user.referrals.length : 0;
            const refEarnings = user.referralEarnings || 0;

            const refCountEl = document.getElementById('refCount');
            const refEarningsEl = document.getElementById('refEarnings');

            if (refCountEl) refCountEl.textContent = refCount;
            if (refEarningsEl) refEarningsEl.textContent = refEarnings.toFixed(8) + ' DGB';
        }
    } catch (error) {
        console.error('Referans istatistikleri güncelleme hatası:', error);
    }
}

// Referans linkini kopyalama
function copyRefLink() {
    const refLink = document.getElementById('refLink');
    if (refLink) {
        refLink.select();
        try {
            document.execCommand('copy');
            showMessage('referralMessage', 'Referans linki kopyalandı!', 'success');
        } catch (err) {
            console.error('Link kopyalama hatası:', err);
            showMessage('referralMessage', 'Link kopyalanamadı!', 'error');
        }
    }
}

// Geçmiş yükleme
async function loadHistory() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const user = data.record.users.find(u => u.email === userEmail);

        if (user) {
            updateClaimHistory(user.claimHistory || []);
            updateWithdrawHistory(user.withdrawals || []);
        }
    } catch (error) {
        console.error('Geçmiş yükleme hatası:', error);
    }
}

// Claim geçmişini güncelleme
function updateClaimHistory(history) {
    const historyDiv = document.getElementById('claimHistory');
    if (!historyDiv) return;

    const html = history
        .slice(-5)
        .reverse()
        .map(claim => `
            <div class="history-item">
                <span><i class="fas fa-coins"></i> ${claim.amount} DGB</span>
                <span>${new Date(claim.timestamp).toLocaleString()}</span>
            </div>
        `).join('') || '<p>Henüz claim yapılmamış.</p>';

    historyDiv.innerHTML = html;
}

// Para çekme geçmişini güncelleme
function updateWithdrawHistory(history) {
    const historyDiv = document.getElementById('withdrawHistory');
    if (!historyDiv) return;

    const html = history
        .slice(-5)
        .reverse()
        .map(withdraw => `
            <div class="history-item">
                <span><i class="fas fa-paper-plane"></i> ${withdraw.amount} DGB</span>
                <span>${new Date(withdraw.timestamp).toLocaleString()}</span>
            </div>
        `).join('') || '<p>Henüz çekim yapılmamış.</p>';

    historyDiv.innerHTML = html;
}

// FaucetPay e-postasını kaydetme
async function saveFaucetPayEmail() {
    const emailInput = document.getElementById('faucetpayEmail');
    const newEmail = emailInput.value.trim();

    if (!newEmail) {
        showMessage('settingsMessage', 'E-posta adresi boş olamaz!', 'error');
        return;
    }

    try {
        // FaucetPay hesap doğrulaması
        const checkResult = await checkFaucetPay(newEmail);
        if (!checkResult.success) {
            showMessage('settingsMessage', 'Geçersiz FaucetPay hesabı!', 'error');
            return;
        }

        // Kullanıcı verisini güncelle
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const userIndex = data.record.users.findIndex(u => u.email === userEmail);

        // FaucetPay e-postasını güncelle
        data.record.users[userIndex].faucetpayEmail = newEmail;

        // Güncellenen veriyi kaydet
        await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': CONFIG.JSONBIN_API_KEY
            },
            body: JSON.stringify(data.record)
        });

        // Yerel depolamayı güncelle
        faucetpayEmail = newEmail;
        localStorage.setItem('faucetpayEmail', newEmail);

        showMessage('settingsMessage', 'FaucetPay e-postası başarıyla güncellendi!', 'success');
    } catch (error) {
        console.error('FaucetPay e-posta güncelleme hatası:', error);
        showMessage('settingsMessage', 'E-posta güncellenemedi!', 'error');
    }
}

// Yükleme göstergesini kontrol etme
function showLoading(show = true) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

// Kullanıcı verilerini yükleme
async function loadUserData() {
    try {
        const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
            headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
        });

        const data = await response.json();
        const user = data.record.users.find(u => u.email === userEmail);

        if (!user) {
            throw new Error('Kullanıcı bulunamadı');
        }

        userBalance = user.balance || 0;
        faucetpayEmail = user.faucetpayEmail || '';
        
        localStorage.setItem('balance', userBalance);
        localStorage.setItem('faucetpayEmail', faucetpayEmail);
        
        updateUI();
        return user;
    } catch (error) {
        console.error('Kullanıcı verisi yükleme hatası:', error);
        throw error;
    }
}

// Claim zamanlayıcısını başlatma
function startClaimTimer() {
    const timerSpan = document.getElementById('timeLeft');
    const claimButton = document.getElementById('claimButton');

    if (!canClaim) {
        claimButton.disabled = true;
        timerSpan.textContent = timeLeft;

        const timer = setInterval(() => {
            timeLeft--;
            timerSpan.textContent = timeLeft;

            if (timeLeft <= 0) {
                clearInterval(timer);
                canClaim = true;
                claimButton.disabled = false;
                timeLeft = 5;
                timerSpan.textContent = 'Hazır!';
            }
        }, 1000);
    }
}

// Kullanıcı arayüzünü güncelleme
function updateUI() {
    const balanceEl = document.getElementById('userBalance');
    if (balanceEl) {
        balanceEl.textContent = userBalance.toFixed(8);
    }

    const faucetpayInput = document.getElementById('faucetpayEmail');
    if (faucetpayInput) {
        faucetpayInput.value = faucetpayEmail;
    }
}

// Çıkış yapma
function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
}

// Tab açma fonksiyonu
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
}

// Sayfa yüklendiğinde başlatma
document.addEventListener('DOMContentLoaded', () => {
    // Gerekli event listener'ları ekle
    const claimButton = document.getElementById('claimButton');
    if (claimButton) {
        claimButton.addEventListener('click', claim);
    }

    const withdrawButton = document.querySelector('button[onclick="withdraw()"]');
    if (withdrawButton) {
        withdrawButton.addEventListener('click', withdraw);
    }

    const copyRefButton = document.querySelector('.copy-btn');
    if (copyRefButton) {
        copyRefButton.addEventListener('click', copyRefLink);
    }

    const saveEmailButton = document.querySelector('button[onclick="saveFaucetPayEmail()"]');
    if (saveEmailButton) {
        saveEmailButton.addEventListener('click', saveFaucetPayEmail);
    }
});
</script>
</body>
</html>
