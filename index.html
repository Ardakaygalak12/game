<h2><i class="fas fa-users"></i> Referans Sistemi</h2>
                        <div class="stats-grid" style="margin: 20px 0;">
                            <div class="stat-card">
                                <i class="fas fa-user-plus fa-2x"></i>
                                <div class="stat-value" id="totalReferrals">0</div>
                                <div>Toplam Referans</div>
                            </div>
                            <div class="stat-card">
                                <i class="fas fa-percentage fa-2x"></i>
                                <div class="stat-value">10%</div>
                                <div>Bonus</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Referans Linkiniz</label>
                            <div class="input-wrapper">
                                <i class="fas fa-link"></i>
                                <input type="text" id="referralLink" readonly>
                            </div>
                            <button class="action-btn" style="margin-top: 10px;" onclick="copyReferralLink()">
                                <i class="fas fa-copy"></i>
                                Kopyala
                            </button>
                        </div>

                        <div class="transaction-list" id="referralHistory"></div>
                    </div>
                </div>
            </div>

            <!-- Lider Tablosu -->
            <div id="leaderboard" class="page">
                <div class="card">
                    <h2><i class="fas fa-trophy"></i> Lider Tablosu</h2>
                    <div class="transaction-list" id="leaderboardList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // KonfigÃ¼rasyon
        const config = {
            jsonbin: {
                binId: '67a7a415e41b4d34e4867ffe',
                apiKey: '$2a$10$m3ykh1NKxmtQDVM140H6TOTqsemkiBEdfdQnG/ApyhjJ1Duj2Ri6W'
            },
            faucetpay: {
                apiKey: 'a5a15c7cc4b4d4c6a0cab0cb5d2b2ce3388070028e2c5cf37284f627975cb9ed'
            }
        };

        // Toast ayarlarÄ±
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-bottom-right",
            "timeOut": "3000"
        };

        // VeritabanÄ± iÅŸlemleri
        class Database {
            static async getData() {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.binId}/latest`, {
                        headers: {
                            'X-Master-Key': config.jsonbin.apiKey
                        }
                    });
                    
                    if (!response.ok) throw new Error('VeritabanÄ± baÄŸlantÄ± hatasÄ±');
                    
                    const data = await response.json();
                    return data.record;
                } catch (error) {
                    console.error('Veri Ã§ekme hatasÄ±:', error);
                    toastr.error('VeritabanÄ±na baÄŸlanÄ±lamadÄ±');
                    return null;
                }
            }

            static async updateData(newData) {
                try {
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${config.jsonbin.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': config.jsonbin.apiKey
                        },
                        body: JSON.stringify(newData)
                    });
                    
                    if (!response.ok) throw new Error('Veri gÃ¼ncelleme hatasÄ±');
                    
                    return await response.json();
                } catch (error) {
                    console.error('Veri gÃ¼ncelleme hatasÄ±:', error);
                    toastr.error('Veriler gÃ¼ncellenirken hata oluÅŸtu');
                    return null;
                }
            }
        }

        // Ana uygulama
        class PepeFaucet {
            constructor() {
                this.initialize();
                this.setupEventListeners();
            }

            async initialize() {
                try {
                    const data = await Database.getData();
                    if (data) {
                        this.updateStats(data);
                        this.updateTransactions(data.transactions || []);
                        this.updateLeaderboard(data.users || {});
                        this.loadUserData(data);
                    }
                } catch (error) {
                    console.error('BaÅŸlatma hatasÄ±:', error);
                    toastr.error('Sistem baÅŸlatÄ±lÄ±rken hata oluÅŸtu');
                }
            }

            setupEventListeners() {
                // Sayfa geÃ§iÅŸleri
                $('.nav-item').click(function() {
                    $('.nav-item').removeClass('active');
                    $(this).addClass('active');
                    
                    const page = $(this).data('page');
                    $('.page').removeClass('active').hide();
                    $(`#${page}`).addClass('active').show();
                });

                // Form iÅŸlemleri
                $('#claimForm').on('submit', async (e) => {
                    e.preventDefault();
                    await this.handleClaim();
                });

                $('#withdrawForm').on('submit', async (e) => {
                    e.preventDefault();
                    await this.handleWithdraw();
                });

                // E-posta otomatik doldurma
                const savedEmail = localStorage.getItem('userEmail');
                if (savedEmail) {
                    $('#email, #withdrawEmail').val(savedEmail);
                    $('#referralLink').val(this.generateReferralLink(savedEmail));
                }
            }

            async handleClaim() {
                const email = $('#email').val();
                if (!email) {
                    toastr.error('LÃ¼tfen e-posta adresinizi girin');
                    return;
                }

                this.setLoading(true, 'claimButton');
                try {
                    const data = await Database.getData();
                    if (!data) throw new Error('Veri yÃ¼klenemedi');

                    // Ã–deme miktarÄ±nÄ± hesapla
                    const amount = this.calculatePayout();
                    
                    // Ä°ÅŸlemi kaydet
                    const transaction = {
                        id: Date.now().toString(),
                        email: email,
                        amount: amount,
                        timestamp: new Date().toISOString(),
                        status: 'success'
                    };

                    // VeritabanÄ±nÄ± gÃ¼ncelle
                    if (!data.transactions) data.transactions = [];
                    if (!data.users) data.users = {};
                    
                    data.transactions.unshift(transaction);
                    
                    if (!data.users[email]) {
                        data.users[email] = {
                            totalClaimed: amount,
                            claimCount: 1
                        };
                    } else {
                        data.users[email].totalClaimed += amount;
                        data.users[email].claimCount += 1;
                    }

                    await Database.updateData(data);
                    
                    // BaÅŸarÄ±lÄ± mesaj
                    toastr.success(`ðŸŽ‰ Tebrikler! ${amount} PEPE kazandÄ±nÄ±z!`);
                    
                    // UI gÃ¼ncelle
                    this.updateStats(data);
                    this.updateTransactions(data.transactions);
                    this.updateLeaderboard(data.users);
                    
                    // KullanÄ±cÄ± bilgilerini kaydet
                    localStorage.setItem('userEmail', email);
                    $('#referralLink').val(this.generateReferralLink(email));

                } catch (error) {
                    console.error('Ä°ÅŸlem hatasÄ±:', error);
                    toastr.error('Ä°ÅŸlem sÄ±rasÄ±nda hata oluÅŸtu');
                } finally {
                    this.setLoading(false, 'claimButton');
                }
            }

            calculatePayout() {
                let amount = Math.floor(Math.random() * (2000 - 800 + 1)) + 800;
                
                // %5 ÅŸansla 2x bonus
                if (Math.random() < 0.05) {
                    amount *= 2;
                    toastr.info('ðŸŽ‰ 2x Bonus kazandÄ±nÄ±z!');
                }
                
                // Referans bonusu
                const referrer = localStorage.getItem('referrer');
                if (referrer) {
                    amount = Math.floor(amount * 1.1);
                }
                
                return amount;
            }

            updateStats(data) {
                const totalUsers = Object.keys(data.users || {}).length;
                const totalPaid = Object.values(data.users || {})
                    .reduce((sum, user) => sum + (user.totalClaimed || 0), 0);
                
                $('#totalUsers').text(totalUsers.toLocaleString());
                $('#totalPaid').text(totalPaid.toLocaleString());
            }

            updateTransactions(transactions) {
                const claimsHtml = transactions
                    .slice(0, 10)
                    .map(tx => `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <span>${this.maskEmail(tx.email)}</span>
                                <small>${moment(tx.timestamp).fromNow()}</small>
                            </div>
                            <div class="transaction-amount">
                                +${tx.amount.toLocaleString()} PEPE
                            </div>
                        </div>
                    `)
                    .join('');
                
                $('#recentClaims').html(claimsHtml || '<p>HenÃ¼z iÅŸlem yok</p>');
            }

            updateLeaderboard(users) {
                const leaderboard = Object.entries(users)
                    .map(([email, data]) => ({
                        email,
                        total: data.totalClaimed || 0
                    }))
                    .sort((a, b) => b.total - a.total)
                    .slice(0, 10)
                    .map((user, index) => `
                        <div class="transaction-item">
                            <div class="transaction-info">
                                <strong>#${index + 1}</strong>
                                <span>${this.maskEmail(user.email)}</span>
                            </div>
                            <div class="transaction-amount">
                                ${user.total.toLocaleString()} PEPE
                            </div>
                        </div>
                    `)
                    .join('');
                
                $('#leaderboardList').html(leaderboard || '<p>HenÃ¼z kullanÄ±cÄ± yok</p>');
            }

            loadUserData(data) {
                const email = localStorage.getItem('userEmail');
                if (email && data.users && data.users[email]) {
                    const userData = data.users[email];
                    $('#userBalance').text(userData.totalClaimed?.toLocaleString() || '0');
                    $('#totalReferrals').text(userData.referralCount || '0');
                }
            }

            generateReferralLink(email) {
                return `https://pepe-free.netlify.app/?ref=${btoa(email)}`;
            }

            maskEmail(email) {
                const [name, domain] = email.split('@');
                return `${name.substring(0, 3)}***@${domain}`;
            }

            setLoading(loading, buttonId) {
                const btn = $(`#${buttonId}`);
                const loader = btn.find('.loading');
                
                btn.prop('disabled', loading);
                if (loading) {
                    loader.show();
                    btn.find('i.fas').hide();
                } else {
                    loader.hide();
                    btn.find('i.fas').show();
                }
            }
        }

        // UygulamayÄ± baÅŸlat
        $(document).ready(() => {
            const app = new PepeFaucet();
            
            // Sayfa yÃ¼klendiÄŸinde referral kontrolÃ¼
            const checkReferral = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const ref = urlParams.get('ref');
                if (ref) {
                    try {
                        const referrerEmail = atob(ref);
                        localStorage.setItem('referrer', referrerEmail);
                        toastr.info('ðŸŽ‰ Referans kodu uygulandÄ±! Ekstra bonus alacaksÄ±nÄ±z!');
                    } catch (e) {
                        console.error('GeÃ§ersiz referans kodu:', e);
                    }
                }
            };

            window.copyReferralLink = async () => {
                const link = $('#referralLink').val();
                try {
                    await navigator.clipboard.writeText(link);
                    toastr.success('âœ¨ Referans linki kopyalandÄ±!');
                } catch (err) {
                    toastr.error('Kopyalama baÅŸarÄ±sÄ±z oldu');
                }
            };

            checkReferral();
        });
    </script>
</body>
</html>
