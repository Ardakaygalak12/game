<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goblin Mining Game</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a2;
            --secondary-color: #2a4;
            --background-dark: #222;
            --background-light: #333;
            --text-light: #fff;
            --text-dark: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        .login-container, .register-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--background-light);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .auth-visible {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border: none;
            border-radius: 5px;
            background-color: var(--background-dark);
            color: var(--text-light);
        }

        button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        .game-container {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--background-light);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .balances {
            display: flex;
            gap: 1rem;
        }

        .balance-item {
            background-color: var(--background-dark);
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .mine-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goblin-shop, .mining-section, .faucet-section {
            background-color: var(--background-light);
            padding: 1rem;
            border-radius: 10px;
        }

        .goblin-card {
            background-color: var(--background-dark);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .earnings-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .ptc-section, .shortlink-section, .withdraw-section {
            background-color: var(--background-light);
            padding: 1rem;
            border-radius: 10px;
        }

        .ptc-ad {
            background-color: var(--background-dark);
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--background-dark);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 5px;
            background-color: var(--primary-color);
            color: var(--text-light);
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .balances {
                flex-direction: column;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>Login</h2>
        <div class="form-group">
            <label for="login-username">Username</label>
            <input type="text" id="login-username" required>
        </div>
        <div class="form-group">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" required>
        </div>
        <button onclick="login()">Login</button>
        <p>Don't have an account? <a href="#" onclick="showRegister()">Register</a></p>
    </div>

    <div class="register-container">
        <h2>Register</h2>
        <div class="form-group">
            <label for="register-username">Username</label>
            <input type="text" id="register-username" required>
        </div>
        <div class="form-group">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" required>
        </div>
        <div class="form-group">
            <label for="referral-code">Referral Code (Optional)</label>
            <input type="text" id="referral-code">
        </div>
        <button onclick="register()">Register</button>
        <p>Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
    </div>

    <div class="game-container">
        <div class="header">
            <h1>Goblin Mining Game</h1>
            <div class="balances">
                <div class="balance-item">
                    <i class="fas fa-coins"></i>
                    GFT: <span id="gft-balance">0</span>
                </div>
                <div class="balance-item">
                    <i class="fas fa-gem"></i>
                    DGB: <span id="dgb-balance">0</span>
                </div>
                <div class="balance-item">
                    <i class="fas fa-dog"></i>
                    DOGE: <span id="doge-balance">0</span>
                </div>
            </div>
        </div>

        <div class="mine-area">
            <div class="goblin-shop">
                <h2>Goblin Shop</h2>
                <div class="goblin-card">
                    <div>
                        <h3>Basic Goblin</h3>
                        <p>Mining Power: 0.1 GFT/min</p>
                        <p>Cost: 100 GFT</p>
                    </div>
                    <button onclick="buyGoblin('basic')">Buy</button>
                </div>
                <div class="goblin-card">
                    <div>
                        <h3>Advanced Goblin</h3>
                        <p>Mining Power: 0.5 GFT/min</p>
                        <p>Cost: 500 GFT</p>
                    </div>
                    <button onclick="buyGoblin('advanced')">Buy</button>
                </div>
                <div class="goblin-card">
                    <div>
                        <h3>Expert Goblin</h3>
                        <p>Mining Power: 2.0 GFT/min</p>
                        <p>Cost: 2000 GFT</p>
                    </div>
                    <button onclick="buyGoblin('expert')">Buy</button>
                </div>
            </div>

            <div class="mining-section">
                <h2>Mining Operation</h2>
                <div id="active-goblins">
                    <!-- Goblin mining status will be populated here -->
                </div>
                <button onclick="collectMining()">Collect Mining Rewards</button>
            </div>

            <div class="faucet-section">
                <h2>Faucet</h2>
                <p>Claim 0.1 GFT every 5 seconds</p>
                <button id="faucet-button" onclick="claimFaucet()">Claim</button>
                <div class="progress-bar">
                    <div id="faucet-progress" class="progress"></div>
                </div>
            </div>
        </div>

        <div class="earnings-area">
            <div class="ptc-section">
                <h2>PTC Ads</h2>
                <div id="ptc-ads">
                    <!-- PTC ads will be populated here -->
                </div>
            </div>

            <div class="shortlink-section">
                <h2>Shortlinks</h2>
                <div id="shortlinks">
                    <!-- Shortlinks will be populated here -->
                </div>
            </div>

            <div class="withdraw-section">
                <h2>Withdraw</h2>
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <input type="number" id="withdraw-amount" min="0" step="0.1">
                </div>
                <div class="form-group">
                    <label for="withdraw-currency">Currency</label>
                    <select id="withdraw-currency">
                        <option value="DGB">DGB</option>
                        <option value="DOGE">DOGE</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="faucetpay-address">FaucetPay Address</label>
                    <input type="text" id="faucetpay-address">
                </div>
                <button onclick="withdraw()">Withdraw to FaucetPay</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // API endpoint
        const API_URL = 'http://localhost:5000';
        let token = localStorage.getItem('token');

        // Show login form on load if no token
        window.onload = () => {
            if (!token) {
                showLogin();
            } else {
                showGame();
                initializeGame();
            }
        };

        // Auth functions
        function showLogin() {
            document.querySelector('.login-container').classList.add('auth-visible');
            document.querySelector('.register-container').classList.remove('auth-visible');
            document.querySelector('.game-container').style.display = 'none';
        }

        function showRegister() {
            document.querySelector('.login-container').classList.remove('auth-visible');
            document.querySelector('.register-container').classList.add('auth-visible');
            document.querySelector('.game-container').style.display = 'none';
        }

        function showGame() {
            document.querySelector('.login-container').classList.remove('auth-visible');
            document.querySelector('.register-container').classList.remove('auth-visible');
            document.querySelector('.game-container').style.display = 'block';
        }

        async function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showGame();
                    initializeGame();
                    showNotification('Login successful!');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error connecting to server', 'error');
            }
        }

        async function register() {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('referral-code').value;

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, referral_code: referralCode })
                });

                const data = await response.json();

                if (response.ok) {
                    showLogin();
                    showNotification('Registration successful! Please login.');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error connecting to server', 'error');
            }
        }

        // Game functions
        async function initializeGame() {
            updateBalances();
            startFaucetTimer();
            loadPtcAds();
            loadShortlinks();
            startMiningInterval();
        }

        async function updateBalances() {
            // Implement balance update logic
        }

        async function buyGoblin(type) {
            try {
                const response = await fetch(`${API_URL}/goblin/buy`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ type })
                });

                const data = await response.json();

                if (response.ok) {
                    updateBalances();
                    showNotification(`Successfully bought ${type} goblin!`);
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error connecting to server', 'error');
            }
        }

        let faucetTimer = null;
        function startFaucetTimer() {
            const progressBar = document.getElementById('faucet-progress');
            const button = document.getElementById('faucet-button');
            let progress = 0;

            faucetTimer = setInterval(() => {
                progress += 2;
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    button.disabled = false;
                    clearInterval(faucetTimer);
                    progressBar.style.width = '0%';
                }
            }, 100);
        }

        async function claimFaucet() {
            const button = document.getElementById('faucet-button');
            button.disabled = true;

            try {
                const response = await fetch(`${API_URL}/faucet/claim`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    updateBalances();
                    showNotification(`Claimed ${data.reward} GFT!`);
                    startFaucetTimer();
                } else {
                    showNotification(data.error, 'error');
                    button.disabled = false;
                }
            } catch (error) {
                showNotification('Error connecting to server', 'error');
                button.disabled = false;
            }
        }

        async function loadPtcAds() {
            try {
                const response = await fetch(`${API_URL}/ptc/list`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const ads = await response.json();
                const container = document.getElementById('ptc-ads');
                container.innerHTML = '';

                ads.forEach(ad => {
                    const adElement = document.createElement('div');
                    adElement.className = 'ptc-ad';
                    adElement.innerHTML = `
                        <h3>${ad.title}</h3>
                        <p>Reward: ${ad.reward} GFT</p>
                        <p>Duration: ${ad.duration} seconds</p>
                        <button onclick="viewPtcAd(${ad.id}, ${ad.duration})">View Ad</button>
                    `;
                    container.appendChild(adElement);
                });
            } catch (error) {
                showNotification('Error loading PTC ads', 'error');
            }
        }

        async function viewPtcAd(adId, duration) {
            const adWindow = window.open('about:blank', 'ptc_ad', 'width=800,height=600');
            let timer = duration;

            try {
                const response = await fetch(`${API_URL}/ptc/view`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ad_id: adId })
                });

                const data = await response.json();

                if (response.ok) {
                    updateBalances();
                    showNotification(`Earned ${data.reward} GFT from PTC ad!`);
                    loadPtcAds();
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error viewing PTC ad', 'error');
            }
        }

        let miningInterval = null;
        function startMiningInterval() {
            miningInterval = setInterval(collectMining, 60000); // Collect every minute
        }

        async function collectMining() {
            try {
                const response = await fetch(`${API_URL}/mine`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.reward > 0) {
                    updateBalances();
                    showNotification(`Collected ${data.reward} GFT from mining!`);
                }
            } catch (error) {
                showNotification('Error collecting mining rewards', 'error');
            }
        }

        async function withdraw() {
            const amount = document.getElementById('withdraw-amount').value;
            const currency = document.getElementById('withdraw-currency').value;
            const address = document.getElementById('faucetpay-address').value;

            if (!amount || !address) {
                showNotification('Please fill all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency,
                        faucetpay_address: address
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    updateBalances();
                    showNotification('Withdrawal successful!');
                } else {
                    showNotification(data.error, 'error');
                }
            } catch (error) {
                showNotification('Error processing withdrawal', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? 'var(--primary-color)' : '#f44336';
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Clean up on page unload
        window.onunload = () => {
            clearInterval(faucetTimer);
            clearInterval(miningInterval);
        };
</script>
</body>
</html>
